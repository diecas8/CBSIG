<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal Usos de Suelo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <style>
        #map { height: 90vh; }
        #controls { padding: 10px; background: #f9f9f9; }
    </style>
</head>
<body>
    <div id="controls">
        <h1>Geoportal Usos de Suelo</h1>
        <p><strong>Geoportal creado por:</strong> Diego Castaño</p>
        <button onclick="exportAll()">Exportar Todo a GeoJSON</button>
        <input type="text" id="fincaFilter" placeholder="Digite cod_finca">
        <button onclick="exportByFinca()">Exportar por Finca</button>
        <div id="summary"></div>
    </div>
    <div id="map"></div>

    <script>
        // Crear el mapa y agregar mapas base
        const map = L.map('map').setView([4.5, -74], 6); // Ajustar coordenadas iniciales

        const baseLayers = {
            'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Map data © <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
            }).addTo(map),
            'Satelital': L.tileLayer('https://mt{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                subdomains: ['0', '1', '2', '3'],
                attribution: 'Map data © Google',
                maxZoom: 20
            }),
            'Topográfico': L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data © <a href="https://opentopomap.org">OpenTopoMap</a>',
                maxZoom: 17
            })
        };
        L.control.layers(baseLayers).addTo(map);

        // Feature Group para almacenar los polígonos
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        // Agregar control de dibujo
        const drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems
            },
            draw: {
                polyline: false,
                marker: false,
                circle: false,
                circlemarker: false
            }
        });
        map.addControl(drawControl);

        // Función para calcular el área en hectáreas
        function calculateArea(layer) {
            const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]) / 10000; // Convertir m² a hectáreas
            return area.toFixed(2);
        }

        // Manejar evento de creación de polígonos
        map.on(L.Draw.Event.CREATED, function (e) {
            const layer = e.layer;
            const areaHectares = calculateArea(layer);

            // Solicitar datos al usuario
            const cod_finca = prompt("Ingrese el código de finca:");
            const cultivo = prompt("Ingrese el tipo de cultivo:");
            const propietario = prompt("Ingrese el propietario:");
            const proyecto = prompt("Ingrese el proyecto asociado:");

            // Agregar propiedades al polígono
            layer.properties = {
                cod_finca: cod_finca,
                cultivo: cultivo,
                area: areaHectares,
                propietario: propietario,
                proyecto: proyecto
            };

            // Estilo del polígono
            layer.setStyle({
                color: 'blue',
                fillColor: 'rgba(0,0,255,0.4)',
                weight: 2
            });

            // Mostrar popup con atributos
            const popupContent = `
                <strong>Código Finca:</strong> ${cod_finca}<br>
                <strong>Cultivo:</strong> ${cultivo}<br>
                <strong>Área (ha):</strong> ${areaHectares}<br>
                <strong>Propietario:</strong> ${propietario}<br>
                <strong>Proyecto:</strong> ${proyecto}
            `;
            layer.bindPopup(popupContent);

            drawnItems.addLayer(layer);
            updateSummary();
        });

        // Función para exportar todos los polígonos a GeoJSON
        function exportAll() {
            const data = drawnItems.toGeoJSON();
            const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "usos_de_suelo.geojson";
            a.click();
            URL.revokeObjectURL(url);
        }

        // Función para exportar polígonos por código de finca
        function exportByFinca() {
            const cod_finca = document.getElementById("fincaFilter").value;
            if (!cod_finca) {
                alert("Por favor ingrese un código de finca.");
                return;
            }

            const data = drawnItems.toGeoJSON();
            const filtered = data.features.filter(f => f.properties.cod_finca === cod_finca);

            if (filtered.length === 0) {
                alert("No se encontraron polígonos para el código de finca ingresado.");
                return;
            }

            const blob = new Blob([JSON.stringify({ type: "FeatureCollection", features: filtered })], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `usos_de_suelo_${cod_finca}.geojson`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Función para mostrar un resumen por finca
        function updateSummary() {
            const data = drawnItems.toGeoJSON();
            const summary = {};

            data.features.forEach(feature => {
                const finca = feature.properties.cod_finca;
                const area = parseFloat(feature.properties.area);

                if (!summary[finca]) {
                    summary[finca] = { area: 0, count: 0 };
                }
                summary[finca].area += area;
                summary[finca].count += 1;
            });

            let html = "<h3>Resumen por Finca</h3><ul>";
            for (const finca in summary) {
                html += `<li>Finca ${finca}: ${summary[finca].count} polígonos, ${summary[finca].area.toFixed(2)} ha</li>`;
            }
            html += "</ul>";
            document.getElementById("summary").innerHTML = html;
        }
    </script>
</body>
</html>
