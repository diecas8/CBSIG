<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dividir Polígonos</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <style>
        #map { height: 100vh; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        const map = L.map('map').setView([4.5, -74], 6);

        // Capas base
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Map data © OpenStreetMap contributors'
        }).addTo(map);

        // Grupo para almacenar polígonos
        const drawnItems = new L.FeatureGroup().addTo(map);

        const drawControl = new L.Control.Draw({
            draw: {
                polyline: true, // Activamos para que se puedan dibujar líneas de corte
                polygon: true,
                circle: false,
                marker: false,
                circlemarker: false
            },
            edit: {
                featureGroup: drawnItems
            }
        });
        map.addControl(drawControl);

        let selectedPolygon = null; // Variable para almacenar el polígono seleccionado

        // Manejar creación de polígonos y líneas
        map.on(L.Draw.Event.CREATED, function (e) {
            const layer = e.layer;

            if (layer instanceof L.Polygon) {
                layer.bindPopup("Polígono creado. Haz clic para seleccionarlo.");
                drawnItems.addLayer(layer);
            } else if (layer instanceof L.Polyline) {
                if (selectedPolygon) {
                    dividePolygon(selectedPolygon, layer);
                } else {
                    alert("Por favor, selecciona un polígono antes de dibujar una línea.");
                }
            }
        });

        // Seleccionar un polígono haciendo clic
        map.on('click', function (e) {
            drawnItems.eachLayer(function (layer) {
                if (layer instanceof L.Polygon && layer.contains(e.latlng)) {
                    selectedPolygon = layer;
                    alert("Polígono seleccionado. Ahora puedes dibujar una línea para dividirlo.");
                }
            });
        });

        // Función para dividir el polígono
        function dividePolygon(polygonLayer, lineLayer) {
            const polygonCoords = polygonLayer.toGeoJSON();
            const lineCoords = lineLayer.toGeoJSON();

            // Dividir el polígono usando Turf.js
            const splitResult = turf.lineSplit(polygonCoords, lineCoords);

            if (splitResult.features.length > 1) {
                drawnItems.removeLayer(polygonLayer); // Remover el polígono original

                splitResult.features.forEach(feature => {
                    const newPolygon = L.geoJSON(feature, {
                        style: { color: 'blue', fillOpacity: 0.5 }
                    }).addTo(drawnItems);

                    newPolygon.bindPopup("Polígono dividido.");
                });

                drawnItems.removeLayer(lineLayer); // Remover la línea de corte
                alert("El polígono se ha dividido con éxito.");
            } else {
                alert("No se pudo dividir el polígono. Verifica que la línea lo intersecte.");
            }
        }
    </script>
</body>
</html>
