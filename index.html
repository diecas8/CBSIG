<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@0.4.15/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@0.4.15/dist/leaflet.draw.js"></script>
    <script src="https://unpkg.com/@turf/turf@6.0.1/turf.min.js"></script>
    <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
    <style>
        #map {
            width: 100%;
            height: 100vh;
        }
        .leaflet-draw-toolbar-top {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
    </style>
</head>
<body>

<div id="map"></div>

<script>
    const map = L.map('map').setView([6.2442, -75.5812], 13); // Centrado en Antioquia, ajusta según necesites

    // Cargar capa base de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Agregar control de geolocalización
    L.control.locate({
        position: 'topright',
        strings: {
            title: "Mostrar mi ubicación"
        },
        drawCircle: true,
        showPopup: true,
    }).addTo(map);

    // Inicializar el dibujo de geometrías
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    const drawControl = new L.Control.Draw({
        edit: {
            featureGroup: drawnItems
        }
    });
    map.addControl(drawControl);

    // Función para manejar los eventos de creación de geometrías
    map.on('draw:created', function (e) {
        const layer = e.layer;
        drawnItems.addLayer(layer);

        if (layer instanceof L.Polygon) {
            const area = turf.area(layer.toGeoJSON());
            const hectares = (area / 10000).toFixed(2); // Conversión a hectáreas
            layer.bindPopup('Cultivo: [Por definir]<br>Área: ' + hectares + ' ha').openPopup();
        }

        if (layer instanceof L.Polyline) {
            const length = turf.length(layer.toGeoJSON(), {units: 'meters'});
            const km = (length / 1000).toFixed(2); // Conversión a kilómetros
            layer.bindPopup('Tipo de Línea: [Por definir]<br>Longitud: ' + km + ' km').openPopup();
        }

        if (layer instanceof L.Marker) {
            layer.bindPopup('Nombre del sitio: [Por definir]').openPopup();
        }

        saveData();
    });

    // Función para guardar datos en LocalStorage
    function saveData() {
        const geojsonData = drawnItems.toGeoJSON();
        localStorage.setItem('geoData', JSON.stringify(geojsonData));
    }

    // Función para cargar los datos guardados
    function loadData() {
        const geojsonData = JSON.parse(localStorage.getItem('geoData'));
        if (geojsonData) {
            L.geoJSON(geojsonData).addTo(drawnItems);
        }
    }

    // Cargar los datos almacenados al inicio
    loadData();

    // Función para exportar a GeoJSON
    function exportGeoJSON() {
        const geojsonData = drawnItems.toGeoJSON();
        const geojsonStr = JSON.stringify(geojsonData);
        const blob = new Blob([geojsonStr], { type: "application/json" });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "geoportal_data.geojson";
        link.click();
    }

    // Botón para exportar a GeoJSON
    const exportButton = document.createElement('button');
    exportButton.textContent = 'Exportar a GeoJSON';
    exportButton.style.position = 'absolute';
    exportButton.style.top = '10px';
    exportButton.style.left = '10px';
    exportButton.onclick = exportGeoJSON;
    document.body.appendChild(exportButton);

</script>

</body>
</html>

