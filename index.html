<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; }
        .btn { padding: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn:disabled { background-color: #ccc; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div style="position: absolute; top: 10px; left: 10px; z-index: 1000;">
        <button class="btn" id="btnAddPolygon" onclick="startPolygon()">Añadir Polígono</button>
        <button class="btn" id="btnAddLine" onclick="startLine()">Añadir Línea</button>
        <button class="btn" id="btnAddPoint" onclick="startPoint()">Añadir Punto</button>
        <button class="btn" id="btnSave" onclick="saveData()">Guardar Datos</button>
        <button class="btn" id="btnExport" onclick="exportGeoJSON()">Exportar GeoJSON</button>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6.5.0"></script>
    <script src="https://unpkg.com/leaflet-geoman-free/dist/leaflet-geoman.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geoman-free/dist/leaflet-geoman.min.css">
    
    <script>
        let map, drawnItems, currentShapeType;
        let geoJsonData = [];
        let currentLocation = null;

        // Inicializa el mapa y los controles
        function initMap() {
            map = L.map('map').setView([6.2435, -75.5812], 14); // Coordenadas de inicio (cambia según tu ubicación)
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            drawnItems = new L.FeatureGroup().addTo(map);
            
            map.pm.addControls({
                position: 'topright',
                drawCircle: false,
                drawRectangle: false,
                drawMarker: false,
                drawPolyline: false
            });

            map.on('pm:create', function(event) {
                const layer = event.layer;
                drawnItems.addLayer(layer);
                handleNewShape(layer);
            });

            getUserLocation();
        }

        // Obtiene la ubicación del usuario a través del GPS
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    currentLocation = [position.coords.latitude, position.coords.longitude];
                    map.setView(currentLocation, 14);
                    L.marker(currentLocation).addTo(map).bindPopup("Tu ubicación").openPopup();
                });
            } else {
                alert("GPS no soportado en tu navegador.");
            }
        }

        // Empieza la captura de un polígono
        function startPolygon() {
            currentShapeType = 'polygon';
            map.pm.enableDraw('Polygon');
            map.pm.setPathOptions({ color: '#ff7800', weight: 5 });
        }

        // Empieza la captura de una línea
        function startLine() {
            currentShapeType = 'line';
            map.pm.enableDraw('Polyline');
            map.pm.setPathOptions({ color: '#00f', weight: 3 });
        }

        // Empieza la captura de un punto
        function startPoint() {
            currentShapeType = 'point';
            map.pm.enableDraw('Marker');
        }

        // Maneja los nuevos objetos geográficos creados
        function handleNewShape(layer) {
            let attributes = {};

            if (currentShapeType === 'polygon') {
                attributes.cultivo = prompt("Introduce el tipo de cultivo:");
                attributes.hectareas = turf.area(layer.toGeoJSON()) / 10000; // Convierte a hectáreas
            } else if (currentShapeType === 'line') {
                attributes.tipoLinea = prompt("Introduce el tipo de línea:");
                attributes.longitud = turf.length(layer.toGeoJSON(), {units: 'kilometers'}); // Longitud en km
            } else if (currentShapeType === 'point') {
                attributes.nombre = prompt("Introduce el nombre del sitio:");
            }

            geoJsonData.push({
                type: "Feature",
                geometry: layer.toGeoJSON().geometry,
                properties: attributes
            });

            // Desactiva el dibujo
            map.pm.disableDraw();
        }

        // Guarda los datos en el dispositivo local
        function saveData() {
            localStorage.setItem('geoData', JSON.stringify(geoJsonData));
            alert("Datos guardados localmente.");
        }

        // Exporta los datos en formato GeoJSON
        function exportGeoJSON() {
            const geoJson = {
                type: "FeatureCollection",
                features: geoJsonData
            };
            const geoJsonStr = JSON.stringify(geoJson);
            const blob = new Blob([geoJsonStr], { type: 'application/geo+json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'datos.geojson';
            link.click();
        }

        // Inicia el mapa
        initMap();
    </script>
</body>
</html>
