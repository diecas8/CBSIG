<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal de Lotes de Café</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; }
        #map { height: 100vh; }
        #header {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 14px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #header h1 {
            font-size: 16px;
            margin: 0;
        }
        #header button {
            font-size: 14px;
            padding: 5px 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
        }
        #header button:hover {
            background-color: #0056b3;
        }
        #footer {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            text-align: right;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Geoportal de Lotes de Café</h1>
        <button onclick="registrarProductor()">Registrar Productor</button>
        <button onclick="registrarFinca()">Registrar Finca</button>
        <button onclick="saveToLocal()">Guardar Lotes</button>
        <button onclick="loadFromLocal()">Cargar Lotes</button>
        <button onclick="exportData()">Exportar GeoJSON</button>
        <button onclick="centerOnUser()">Ir a Mi Ubicación</button>
        <button onclick="buscarFinca()">Buscar Finca por Código</button>
        <button onclick="toggleDrawTools()">Activar Herramientas de Dibujo</button>
    </div>
    <div id="map"></div>
    <div id="footer">
        Geoportal creado por Diego Castaño
    </div>

    <script>
       // Inicialización del mapa
const map = L.map('map').setView([4.5709, -74.2973], 6); // Coordenadas de inicio

// Capa de mapa base
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

// Array de productores (debería ser cargado desde el almacenamiento o base de datos)
let productores = [
    { id: 1, nombre: 'Productor A' },
    { id: 2, nombre: 'Productor B' }
];

// Array de fincas (debería ser cargado desde el almacenamiento)
let fincas = JSON.parse(localStorage.getItem('fincas')) || [];

// Función para guardar atributos de la finca
function guardarAtributosPoligono(layerGeoJson) {
    const codigoFinca = document.getElementById("codigoFinca").value;
    const nombreFinca = document.getElementById("nombreFinca").value;
    const areaFinca = document.getElementById("areaFinca").value;
    const idProductor = document.getElementById("productorFinca").value;

    if (!codigoFinca || !nombreFinca || !areaFinca || !idProductor) {
        alert("Por favor, complete todos los campos.");
        return;
    }

    const productor = productores.find(p => p.id === idProductor);
    if (!productor) {
        alert("Productor no válido.");
        return;
    }

    // Crear objeto finca con los atributos y la geometría
    const finca = {
        codigo: codigoFinca,
        nombre: nombreFinca,
        area: areaFinca,
        productor: productor,
        geoJson: layerGeoJson // Guardar la geometría del polígono
    };

    fincas.push(finca);
    localStorage.setItem("fincas", JSON.stringify(fincas)); // Guardar en el almacenamiento

    alert("Atributos de finca guardados.");
    map.closePopup();
}

// Activar/desactivar herramientas de dibujo
let drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);

const drawControl = new L.Control.Draw({
    edit: {
        featureGroup: drawnItems
    },
    draw: {
        polygon: {
            shapeOptions: {
                color: '#ff7800',
                weight: 4
            }
        },
        rectangle: true,
        polyline: true,
        circle: true,
        marker: true
    }
});

let drawToolsEnabled = false;

function toggleDrawTools() {
    if (drawToolsEnabled) {
        map.removeControl(drawControl);
    } else {
        map.addControl(drawControl);
    }
    drawToolsEnabled = !drawToolsEnabled;
}

map.on(L.Draw.Event.CREATED, function (e) {
    const layer = e.layer;
    drawnItems.addLayer(layer);

    // Formulario para ingresar atributos automáticamente al crear el polígono
    const form = `
        <form id="atributosForm">
            <label for="codigoFinca">Código de Finca:</label><br>
            <input type="text" id="codigoFinca" required><br>
            <label for="nombreFinca">Nombre de Finca:</label><br>
            <input type="text" id="nombreFinca" required><br>
            <label for="areaFinca">Área (ha):</label><br>
            <input type="number" id="areaFinca" required><br>
            <label for="productorFinca">Productor:</label><br>
            <select id="productorFinca" required>
                ${productores.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('')}
            </select><br>
            <button type="button" onclick="guardarAtributosPoligono(${JSON.stringify(layer.toGeoJSON())})">Guardar Atributos</button>
        </form>
    `;

    L.popup()
        .setLatLng(layer.getBounds().getCenter())
        .setContent(form)
        .openOn(map);
});

// Función para mostrar los atributos de una finca cuando se hace clic en el marcador o polígono
map.on('popupopen', function (e) {
    const layer = e.target._source;

    // Mostrar atributos en el popup si ya están guardados
    const finca = fincas.find(f => f.geoJson && f.geoJson.id === layer._leaflet_id);
    if (finca) {
        const { codigo, nombre, area, productor } = finca;
        const popupContent = `
            <b>Finca:</b> ${nombre} <br>
            <b>Código:</b> ${codigo} <br>
            <b>Área:</b> ${area} ha <br>
            <b>Productor:</b> ${productor.nombre} <br>
        `;
        e.target.setPopupContent(popupContent);
    }
});

// Buscar finca por código
function buscarFinca() {
    const codigo = prompt("Ingrese el código de la finca:");
    const finca = fincas.find(f => f.codigo === codigo);

    if (finca) {
        const latlng = turf.centerOfMass(finca.geoJson).geometry.coordinates.reverse();
        map.setView(latlng, 16); // Hacer zoom en la finca encontrada
        L.marker(latlng).addTo(map).bindPopup(`Finca: ${finca.nombre}<br>Área: ${finca.area}`).openPopup();
    } else {
        alert("Finca no encontrada.");
    }
}

// Señalización de ubicación actual
function centerOnUser() {
    map.locate({ setView: true, maxZoom: 16 });
}

// Exportar datos en formato GeoJSON
function exportData() {
    const geoJson = drawnItems.toGeoJSON();
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(geoJson));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "fincas.geojson");
    downloadAnchorNode.click();
}

    </script>
</body>
</html>

