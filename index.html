<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal de Lotes de Café</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; }
        #map { height: 100vh; }
        #header {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 14px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #header h1 {
            font-size: 16px;
            margin: 0;
        }
        #header button {
            font-size: 14px;
            padding: 5px 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
        }
        #header button:hover {
            background-color: #0056b3;
        }
        #footer {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            text-align: right;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Geoportal de Lotes de Café</h1>
        <button onclick="registrarProductor()">Registrar Productor</button>
        <button onclick="registrarFinca()">Registrar Finca</button>
        <button onclick="saveToLocal()">Guardar Lotes</button>
        <button onclick="loadFromLocal()">Cargar Lotes</button>
        <button onclick="exportData()">Exportar GeoJSON</button>
        <button onclick="centerOnUser()">Ir a Mi Ubicación</button>
    </div>
    <div id="map"></div>
    <div id="footer">
        Geoportal creado por Diego Castaño
    </div>

   <script>
    // Crear lote
    map.on(L.Draw.Event.CREATED, function (e) {
        if (fincas.length === 0) {
            alert("Debe registrar al menos una finca antes de dibujar lotes.");
            return;
        }

        const layer = e.layer;

        // Lista de variedades de café
        const variedades = [
            "Castillo", "Suprema", "Colombia", "Caturra", "Tabi",
            "Cenicafe 1", "Cenicafe 2", "Borbón", "Geisha", "Costa Rica", "Otros"
        ];

        const form = `
            <form id="loteForm">
                <label for="fincaLote">Seleccione Finca:</label><br>
                <select id="fincaLote" required>
                    ${fincas.map(f => `<option value="${f.codigo}">${f.nombre} (${f.codigo})</option>`).join('')}
                </select><br>
                <label for="variedadCafe">Variedad de Café:</label><br>
                <select id="variedadCafe" required>
                    ${variedades.map(v => `<option value="${v}">${v}</option>`).join('')}
                </select><br>
                <label for="fechaLabor">Fecha de Labor:</label><br>
                <input type="date" id="fechaLabor" required><br>
                <label for="tipoLabor">Tipo de Labor:</label><br>
                <select id="tipoLabor" required>
                    <option value="Siembra Nueva">Siembra Nueva</option>
                    <option value="Renovación por Zoca">Renovación por Zoca</option>
                    <option value="Renovación por Siembra">Renovación por Siembra</option>
                </select><br>
                <label for="distanciaSurcos">Distancia entre Surcos (m):</label><br>
                <input type="number" id="distanciaSurcos" required><br>
                <label for="distanciaPlantas">Distancia entre Plantas (m):</label><br>
                <input type="number" id="distanciaPlantas" required><br>
                <label for="luminosidad">Luminosidad (%):</label><br>
                <input type="number" id="luminosidad" required><br>
                <button type="button" onclick="guardarLote()">Guardar</button>
            </form>
        `;

        const popup = L.popup()
            .setLatLng(e.layer.getBounds().getCenter())
            .setContent(form)
            .openOn(map);

        // Obtener altura con GPS
        navigator.geolocation.getCurrentPosition(function (position) {
            const altura = position.coords.altitude || "Altura no disponible";

            document.getElementById("loteForm").insertAdjacentHTML(
                "beforeend",
                `<label>Altura sobre el Nivel del Mar (m):</label><br>
                 <input type="text" id="alturaGPS" value="${altura}" readonly><br>`
            );
        });

        window.guardarLote = function () {
            const fincaCodigo = document.getElementById("fincaLote").value;
            const variedad = document.getElementById("variedadCafe").value;
            const fecha = document.getElementById("fechaLabor").value;
            const tipo = document.getElementById("tipoLabor").value;
            const distanciaSurcos = document.getElementById("distanciaSurcos").value;
            const distanciaPlantas = document.getElementById("distanciaPlantas").value;
            const luminosidad = document.getElementById("luminosidad").value;
            const altura = document.getElementById("alturaGPS").value;

            if (!fincaCodigo || !variedad || !fecha || !tipo || !distanciaSurcos || !distanciaPlantas || !luminosidad) {
                alert("Por favor, complete todos los campos del lote.");
                return;
            }

            const finca = fincas.find(f => f.codigo === fincaCodigo);
            const loteCodigo = `${fincaCodigo}-${loteCounter[fincaCodigo]++}`;
            const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]) / 10000;

            layer.properties = {
                fincaCodigo,
                loteCodigo,
                variedad,
                fecha,
                tipo,
                distanciaSurcos,
                distanciaPlantas,
                luminosidad,
                altura,
                area: area.toFixed(2),
                tipoLote: "Café"
            };

            layer.setStyle({ color: 'orange', fillOpacity: 0.5 });
            layer.bindPopup(`
                <strong>Código de Finca:</strong> ${fincaCodigo}<br>
                <strong>Código de Lote:</strong> ${loteCodigo}<br>
                <strong>Variedad:</strong> ${variedad}<br>
                <strong>Fecha de Labor:</strong> ${fecha}<br>
                <strong>Tipo de Labor:</strong> ${tipo}<br>
                <strong>Distancia entre Surcos:</strong> ${distanciaSurcos} m<br>
                <strong>Distancia entre Plantas:</strong> ${distanciaPlantas} m<br>
                <strong>Luminosidad:</strong> ${luminosidad}%<br>
                <strong>Altura:</strong> ${altura} m<br>
                <strong>Área:</strong> ${area.toFixed(2)} ha
            `);

            loteLayer.addLayer(layer);
            map.closePopup();
        };
    });

    // Exportar todos los lotes a GeoJSON
    function exportData() {
        const loteData = loteLayer.toGeoJSON();
        const blob = new Blob([JSON.stringify(loteData)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "lotes_cafe.geojson";
        a.click();
        URL.revokeObjectURL(url);
    }

    // Guardar lotes localmente
    function saveToLocal() {
        const loteData = loteLayer.toGeoJSON();
        localStorage.setItem("loteData", JSON.stringify(loteData));
        alert("Lotes guardados localmente.");
    }

    // Cargar lotes desde almacenamiento local
    function loadFromLocal() {
        const savedData = localStorage.getItem("loteData");
        if (!savedData) {
            alert("No hay lotes guardados.");
            return;
        }

        loteLayer.clearLayers();

        const loteGeoJSON = JSON.parse(savedData);
        L.geoJSON(loteGeoJSON, {
            onEachFeature: function (feature, layer) {
                layer.setStyle({ color: 'orange', fillOpacity: 0.5 });
                layer.bindPopup(`
                    <strong>Código de Finca:</strong> ${feature.properties.fincaCodigo}<br>
                    <strong>Código de Lote:</strong> ${feature.properties.loteCodigo}<br>
                    <strong>Variedad:</strong> ${feature.properties.variedad}<br>
                    <strong>Fecha de Labor:</strong> ${feature.properties.fecha}<br>
                    <strong>Tipo de Labor:</strong> ${feature.properties.tipo}<br>
                    <strong>Distancia entre Surcos:</strong> ${feature.properties.distanciaSurcos} m<br>
                    <strong>Distancia entre Plantas:</strong> ${feature.properties.distanciaPlantas} m<br>
                    <strong>Luminosidad:</strong> ${feature.properties.luminosidad}%<br>
                    <strong>Altura:</strong> ${feature.properties.altura} m<br>
                    <strong>Área:</strong> ${feature.properties.area} ha
                `);
                loteLayer.addLayer(layer);
            }
        });

        alert("Lotes cargados correctamente.");
    }
</script>

</body>
</html>
