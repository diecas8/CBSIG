<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal con GPS y Control de Dibujo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geoman-free@2.13.0/dist/leaflet-geoman.css" />
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; }
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
        }
        .btn {
            display: block;
            margin-bottom: 5px;
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-secondary {
            background-color: #007BFF;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="controls">
        <button class="btn" onclick="startPolygon()">Añadir Polígono</button>
        <button class="btn" onclick="startLine()">Añadir Línea</button>
        <button class="btn" onclick="startPoint()">Añadir Punto</button>
        <button class="btn btn-secondary" onclick="centerToLocation()">Centrar en Mi Ubicación</button>
        <button class="btn" onclick="saveData()">Guardar Datos</button>
        <button class="btn" onclick="exportGeoJSON()">Exportar GeoJSON</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-geoman-free@2.13.0/dist/leaflet-geoman.min.js"></script>
    <script src="https://unpkg.com/@turf/turf@6.5.0"></script>
    <script>
        let map;
        let geoJsonData = [];
        let currentShapeType = null;
        let userLocation = null; // Guarda la ubicación del usuario

        function initMap() {
            // Inicializa el mapa
            map = L.map('map').setView([0, 0], 2); // Vista global por defecto

            // Añade una capa base
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Activa los controles de Leaflet-Geoman
            if (typeof map.pm !== 'undefined') {
                map.pm.addControls({
                    position: 'topleft',
                    drawMarker: true,
                    drawPolygon: true,
                    drawPolyline: true,
                    editMode: true,
                    removalMode: true
                });

                // Detecta nuevas geometrías dibujadas
                map.on('pm:create', function (e) {
                    handleNewShape(e.layer);
                });

                // Obtiene la ubicación del usuario y centra el mapa
                getUserLocation();
            } else {
                alert("Leaflet-Geoman no está disponible. Revisa la carga de las librerías.");
            }
        }

        // Obtiene la ubicación actual del usuario
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    const { latitude, longitude } = position.coords;
                    userLocation = [latitude, longitude]; // Guarda la ubicación
                    map.setView(userLocation, 14); // Centra el mapa en la ubicación
                    L.marker(userLocation).addTo(map).bindPopup("Tu ubicación actual").openPopup();
                }, function (error) {
                    console.error("Error al obtener la ubicación:", error.message);
                    alert("No se pudo obtener la ubicación. Usa el botón de centrar.");
                });
            } else {
                alert("Geolocalización no soportada en este navegador.");
            }
        }

        // Centra el mapa en la ubicación del usuario
        function centerToLocation() {
            if (userLocation) {
                map.setView(userLocation, 14); // Centra el mapa en la última ubicación conocida
                L.marker(userLocation).addTo(map).bindPopup("Tu ubicación actual").openPopup();
            } else {
                alert("No se ha detectado la ubicación. Asegúrate de habilitar el GPS.");
            }
        }

        // Inicia el dibujo de polígonos
        function startPolygon() {
            if (map.pm) {
                currentShapeType = 'polygon';
                map.pm.enableDraw('Polygon');
            } else {
                alert("El control de dibujo no está disponible.");
            }
        }

        // Inicia el dibujo de líneas
        function startLine() {
            if (map.pm) {
                currentShapeType = 'line';
                map.pm.enableDraw('Line');
            } else {
                alert("El control de dibujo no está disponible.");
            }
        }

        // Inicia el dibujo de puntos
        function startPoint() {
            if (map.pm) {
                currentShapeType = 'point';
                map.pm.enableDraw('Marker');
            } else {
                alert("El control de dibujo no está disponible.");
            }
        }

        // Maneja las geometrías nuevas creadas por el usuario
        function handleNewShape(layer) {
            const geojson = layer.toGeoJSON();
            const attributes = {};

            if (currentShapeType === 'polygon') {
                attributes.cultivo = prompt("Introduce el tipo de cultivo:");
                attributes.hectareas = (turf.area(geojson) / 10000).toFixed(2); // Calcula área en hectáreas
            } else if (currentShapeType === 'line') {
                attributes.tipoLinea = prompt("Introduce el tipo de línea:");
                attributes.longitud = turf.length(geojson, { units: 'kilometers' }).toFixed(2); // Longitud en kilómetros
            } else if (currentShapeType === 'point') {
                attributes.nombre = prompt("Introduce el nombre del sitio:");
            }

            geoJsonData.push({
                type: "Feature",
                geometry: geojson.geometry,
                properties: attributes
            });

            map.pm.disableDraw(); // Desactiva el modo de dibujo
        }

        // Guarda los datos en el almacenamiento local
        function saveData() {
            localStorage.setItem('geoData', JSON.stringify(geoJsonData));
            alert("Datos guardados localmente.");
        }

        // Exporta los datos como GeoJSON
        function exportGeoJSON() {
            const geoJson = {
                type: "FeatureCollection",
                features: geoJsonData
            };
            const blob = new Blob([JSON.stringify(geoJson)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'datos.geojson';
            link.click();
        }

        // Inicializa el mapa al cargar la página
        initMap();
    </script>
</body>
</html>
